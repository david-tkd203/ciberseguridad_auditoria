' ========================================================================
' SGSI COMPLETO v3.0 - MACROS MEJORADAS
' Sistema de Gesti√≥n de Seguridad de la Informaci√≥n ISO 27001:2022
' Fecha: 04/11/2025
' ========================================================================

Option Explicit

' ========================================================================
' M√ìDULO 1: GESTI√ìN DE ACTIVOS
' ========================================================================

Sub IngresarNuevoActivo()
    On Error GoTo ErrorHandler
    
    Dim ws As Worksheet
    Dim ultimaFila As Long
    Dim nuevoID As String
    Dim respuesta As VbMsgBoxResult
    
    ' Validar que existe la hoja
    On Error Resume Next
    Set ws = ThisWorkbook.Sheets("Activos")
    On Error GoTo ErrorHandler
    
    If ws Is Nothing Then
        MsgBox "Error: No se encontr√≥ la hoja 'Activos'", vbCritical, "Error"
        Exit Sub
    End If
    
    ' Confirmar acci√≥n
    respuesta = MsgBox("¬øDesea crear un nuevo activo?" & vbCrLf & vbCrLf & _
                       "Se generar√° un ID autom√°tico y se habilitar√° la fila para ingreso de datos.", _
                       vbQuestion + vbYesNo, "Confirmar Nuevo Activo")
    
    If respuesta = vbNo Then Exit Sub
    
    ' Encontrar √∫ltima fila
    ultimaFila = ws.Cells(ws.Rows.Count, 1).End(xlUp).Row + 1
    
    ' Generar ID autom√°tico con formato ACT-YYYY-NNN
    nuevoID = "ACT-" & Year(Date) & "-" & Format(ultimaFila - 1, "000")
    
    ' Aplicar protecci√≥n desactivada temporalmente
    ws.Unprotect
    
    ' Ingresar datos autom√°ticos
    ws.Cells(ultimaFila, 1).Value = nuevoID
    ws.Cells(ultimaFila, 17).Value = "Activo"
    ws.Cells(ultimaFila, 18).Value = Date
    ws.Cells(ultimaFila, 19).Value = Date
    ws.Cells(ultimaFila, 20).Value = Application.UserName
    
    ' Aplicar formato a la fila
    With ws.Range(ws.Cells(ultimaFila, 1), ws.Cells(ultimaFila, 20))
        .Borders.Weight = xlThin
        .Font.Name = "Arial"
        .Font.Size = 10
    End With
    
    ' Proteger hoja nuevamente (ajustar seg√∫n necesidad)
    ' ws.Protect
    
    ' Seleccionar celda de nombre
    ws.Cells(ultimaFila, 2).Select
    
    ' Registrar en log
    Call RegistrarAccion("Nuevo activo creado: " & nuevoID)
    
    MsgBox "‚úÖ Nuevo activo creado exitosamente" & vbCrLf & vbCrLf & _
           "ID: " & nuevoID & vbCrLf & _
           "Fila: " & ultimaFila & vbCrLf & vbCrLf & _
           "Complete los siguientes campos obligatorios:" & vbCrLf & _
           "  ‚Ä¢ Nombre del Activo (columna B)" & vbCrLf & _
           "  ‚Ä¢ Categor√≠a (columna C - use lista)" & vbCrLf & _
           "  ‚Ä¢ Subcategor√≠a (columna D - use lista)" & vbCrLf & _
           "  ‚Ä¢ Criticidad C/I/A (columnas O/P/Q)", _
           vbInformation, "Activo Creado"
    
    Exit Sub

ErrorHandler:
    MsgBox "Error al crear activo: " & Err.Description, vbCritical, "Error"
End Sub

Sub AgregarCategoria()
    On Error GoTo ErrorHandler
    
    Dim ws As Worksheet
    Dim ultimaFila As Long
    Dim nuevoID As String
    Dim nombreCat As String
    Dim descripcion As String
    
    Set ws = ThisWorkbook.Sheets("Config_Categorias")
    
    ' Solicitar datos con validaci√≥n
    Do
        nombreCat = InputBox("Ingrese el nombre de la nueva categor√≠a:" & vbCrLf & _
                            "(Ejemplo: Hardware, Software, Datos, Personal)", _
                            "Nueva Categor√≠a")
        
        If nombreCat = "" Then Exit Sub
        
        If Len(nombreCat) < 3 Then
            MsgBox "El nombre debe tener al menos 3 caracteres", vbExclamation
        Else
            Exit Do
        End If
    Loop
    
    descripcion = InputBox("Ingrese una descripci√≥n (opcional):", "Descripci√≥n de Categor√≠a")
    
    ' Verificar duplicados
    Dim i As Long
    For i = 7 To ws.Cells(ws.Rows.Count, 3).End(xlUp).Row
        If UCase(Trim(ws.Cells(i, 3).Value)) = UCase(Trim(nombreCat)) Then
            MsgBox "Ya existe una categor√≠a con ese nombre", vbExclamation
            Exit Sub
        End If
    Next i
    
    ultimaFila = ws.Cells(ws.Rows.Count, 2).End(xlUp).Row + 1
    nuevoID = "CAT-" & Format(ultimaFila - 6, "000")
    
    ws.Unprotect
    ws.Cells(ultimaFila, 2).Value = nuevoID
    ws.Cells(ultimaFila, 3).Value = nombreCat
    ws.Cells(ultimaFila, 4).Value = descripcion
    
    ' Formato
    With ws.Range(ws.Cells(ultimaFila, 2), ws.Cells(ultimaFila, 4))
        .Borders.Weight = xlThin
        .Font.Name = "Arial"
        .Font.Size = 10
    End With
    
    Call RegistrarAccion("Nueva categor√≠a: " & nombreCat)
    
    MsgBox "‚úÖ Categor√≠a agregada exitosamente: " & nombreCat, vbInformation, "√âxito"
    
    Exit Sub

ErrorHandler:
    MsgBox "Error: " & Err.Description, vbCritical
End Sub

' ========================================================================
' M√ìDULO 2: GESTI√ìN DE RIESGOS
' ========================================================================

Sub IngresarNuevoRiesgo()
    On Error GoTo ErrorHandler
    
    Dim ws As Worksheet
    Dim ultimaFila As Long
    Dim nuevoID As String
    
    Set ws = ThisWorkbook.Sheets("Matriz_Riesgos")
    ultimaFila = ws.Cells(ws.Rows.Count, 1).End(xlUp).Row + 1
    
    ' Confirmar
    If MsgBox("¬øCrear nuevo riesgo?", vbQuestion + vbYesNo) = vbNo Then Exit Sub
    
    ' ID autom√°tico
    nuevoID = "RIS-" & Year(Date) & "-" & Format(ultimaFila - 1, "000")
    
    ws.Unprotect
    ws.Cells(ultimaFila, 1).Value = nuevoID
    ws.Cells(ultimaFila, 13).Value = "Identificado"
    ws.Cells(ultimaFila, 14).Value = Date
    ws.Cells(ultimaFila, 15).Value = Application.UserName
    
    ' Formato
    With ws.Range(ws.Cells(ultimaFila, 1), ws.Cells(ultimaFila, 15))
        .Borders.Weight = xlThin
    End With
    
    ws.Cells(ultimaFila, 2).Select
    
    Call RegistrarAccion("Nuevo riesgo: " & nuevoID)
    
    MsgBox "‚úÖ Riesgo creado: " & nuevoID & vbCrLf & vbCrLf & _
           "Complete:" & vbCrLf & _
           "  ‚Ä¢ Descripci√≥n del riesgo" & vbCrLf & _
           "  ‚Ä¢ Amenaza y Vulnerabilidad" & vbCrLf & _
           "  ‚Ä¢ Probabilidad (1-5)" & vbCrLf & _
           "  ‚Ä¢ Impacto (1-5)", vbInformation
    
    Exit Sub

ErrorHandler:
    MsgBox "Error: " & Err.Description, vbCritical
End Sub

Sub CalcularRiesgoInherente()
    On Error GoTo ErrorHandler
    
    Dim ws As Worksheet
    Dim i As Long
    Dim prob As Integer
    Dim impacto As Integer
    Dim riesgo As Integer
    Dim contador As Long
    
    Set ws = ThisWorkbook.Sheets("Matriz_Riesgos")
    contador = 0
    
    ws.Unprotect
    
    ' Calcular desde fila 2 (asumiendo header en fila 1)
    For i = 2 To ws.Cells(ws.Rows.Count, 1).End(xlUp).Row
        ' Leer probabilidad e impacto (ajustar columnas seg√∫n tu dise√±o)
        prob = ws.Cells(i, 5).Value ' Columna E: Probabilidad
        impacto = ws.Cells(i, 6).Value ' Columna F: Impacto
        
        If prob > 0 And impacto > 0 Then
            riesgo = prob * impacto
            ws.Cells(i, 7).Value = riesgo ' Columna G: Riesgo Inherente
            
            ' Clasificar nivel de riesgo
            If riesgo >= 15 Then
                ws.Cells(i, 8).Value = "CR√çTICO"
                ws.Cells(i, 8).Interior.Color = RGB(192, 0, 0) ' Rojo
            ElseIf riesgo >= 10 Then
                ws.Cells(i, 8).Value = "ALTO"
                ws.Cells(i, 8).Interior.Color = RGB(255, 107, 0) ' Naranja
            ElseIf riesgo >= 5 Then
                ws.Cells(i, 8).Value = "MEDIO"
                ws.Cells(i, 8).Interior.Color = RGB(255, 192, 0) ' Amarillo
            Else
                ws.Cells(i, 8).Value = "BAJO"
                ws.Cells(i, 8).Interior.Color = RGB(146, 208, 80) ' Verde
            End If
            
            ws.Cells(i, 8).Font.Color = RGB(255, 255, 255)
            ws.Cells(i, 8).Font.Bold = True
            
            contador = contador + 1
        End If
    Next i
    
    Call RegistrarAccion("C√°lculo riesgo inherente: " & contador & " riesgos")
    
    MsgBox "‚úÖ Riesgos calculados: " & contador, vbInformation, "C√°lculo Completado"
    
    Exit Sub

ErrorHandler:
    MsgBox "Error: " & Err.Description, vbCritical
End Sub

Sub ColorearRiesgos()
    On Error GoTo ErrorHandler
    
    Dim ws As Worksheet
    Dim i As Long
    Dim nivelRiesgo As String
    Dim contador As Long
    
    Set ws = ThisWorkbook.Sheets("Matriz_Riesgos")
    contador = 0
    
    ws.Unprotect
    
    For i = 2 To ws.Cells(ws.Rows.Count, 1).End(xlUp).Row
        nivelRiesgo = UCase(Trim(ws.Cells(i, 8).Value))
        
        Select Case nivelRiesgo
            Case "CR√çTICO", "CRITICO"
                ws.Cells(i, 8).Interior.Color = RGB(192, 0, 0)
                ws.Cells(i, 8).Font.Color = RGB(255, 255, 255)
                contador = contador + 1
                
            Case "ALTO"
                ws.Cells(i, 8).Interior.Color = RGB(255, 107, 0)
                ws.Cells(i, 8).Font.Color = RGB(255, 255, 255)
                contador = contador + 1
                
            Case "MEDIO"
                ws.Cells(i, 8).Interior.Color = RGB(255, 192, 0)
                ws.Cells(i, 8).Font.Color = RGB(0, 0, 0)
                contador = contador + 1
                
            Case "BAJO"
                ws.Cells(i, 8).Interior.Color = RGB(146, 208, 80)
                ws.Cells(i, 8).Font.Color = RGB(255, 255, 255)
                contador = contador + 1
        End Select
        
        ws.Cells(i, 8).Font.Bold = True
        ws.Cells(i, 8).HorizontalAlignment = xlCenter
    Next i
    
    Call RegistrarAccion("Coloreado de riesgos: " & contador)
    
    MsgBox "‚úÖ Riesgos coloreados: " & contador, vbInformation
    
    Exit Sub

ErrorHandler:
    MsgBox "Error: " & Err.Description, vbCritical
End Sub

' ========================================================================
' M√ìDULO 3: PLAN DE TRATAMIENTO
' ========================================================================

Sub IngresarNuevoTratamiento()
    On Error GoTo ErrorHandler
    
    Dim ws As Worksheet
    Dim ultimaFila As Long
    Dim nuevoID As String
    
    Set ws = ThisWorkbook.Sheets("Plan_Tratamiento")
    ultimaFila = ws.Cells(ws.Rows.Count, 1).End(xlUp).Row + 1
    
    nuevoID = "TRT-" & Year(Date) & "-" & Format(ultimaFila - 1, "000")
    
    ws.Unprotect
    ws.Cells(ultimaFila, 1).Value = nuevoID
    ws.Cells(ultimaFila, 8).Value = "Planificado"
    ws.Cells(ultimaFila, 9).Value = Date
    ws.Cells(ultimaFila, 11).Value = 0 ' Progreso inicial
    
    With ws.Range(ws.Cells(ultimaFila, 1), ws.Cells(ultimaFila, 12))
        .Borders.Weight = xlThin
    End With
    
    ws.Cells(ultimaFila, 2).Select
    
    Call RegistrarAccion("Nuevo tratamiento: " & nuevoID)
    
    MsgBox "‚úÖ Tratamiento creado: " & nuevoID, vbInformation
    
    Exit Sub

ErrorHandler:
    MsgBox "Error: " & Err.Description, vbCritical
End Sub

' ========================================================================
' M√ìDULO 4: DASHBOARD Y REPORTES
' ========================================================================

Sub ActualizarDashboard()
    On Error GoTo ErrorHandler
    
    Dim wsDash As Worksheet
    Dim wsActivos As Worksheet
    Dim wsRiesgos As Worksheet
    Dim totalActivos As Long
    Dim totalRiesgos As Long
    Dim riesgosCriticos As Long
    Dim i As Long
    
    Set wsDash = ThisWorkbook.Sheets("Dashboard")
    Set wsActivos = ThisWorkbook.Sheets("Activos")
    Set wsRiesgos = ThisWorkbook.Sheets("Matriz_Riesgos")
    
    Application.ScreenUpdating = False
    
    ' Contar activos
    totalActivos = wsActivos.Cells(wsActivos.Rows.Count, 1).End(xlUp).Row - 1
    
    ' Contar riesgos
    totalRiesgos = wsRiesgos.Cells(wsRiesgos.Rows.Count, 1).End(xlUp).Row - 1
    
    ' Contar riesgos cr√≠ticos
    riesgosCriticos = 0
    For i = 2 To wsRiesgos.Cells(wsRiesgos.Rows.Count, 1).End(xlUp).Row
        If UCase(Trim(wsRiesgos.Cells(i, 8).Value)) = "CR√çTICO" Or _
           UCase(Trim(wsRiesgos.Cells(i, 8).Value)) = "CRITICO" Then
            riesgosCriticos = riesgosCriticos + 1
        End If
    Next i
    
    ' Actualizar dashboard (ajustar celdas seg√∫n tu dise√±o)
    wsDash.Range("B5").Value = totalActivos
    wsDash.Range("B6").Value = totalRiesgos
    wsDash.Range("B7").Value = riesgosCriticos
    wsDash.Range("B8").Value = Date
    
    Application.ScreenUpdating = True
    
    Call RegistrarAccion("Dashboard actualizado")
    
    MsgBox "‚úÖ Dashboard actualizado" & vbCrLf & vbCrLf & _
           "Activos: " & totalActivos & vbCrLf & _
           "Riesgos: " & totalRiesgos & vbCrLf & _
           "Cr√≠ticos: " & riesgosCriticos, vbInformation
    
    Exit Sub

ErrorHandler:
    Application.ScreenUpdating = True
    MsgBox "Error: " & Err.Description, vbCritical
End Sub

Sub ExportarReporteCompleto()
    MsgBox "Funcionalidad en desarrollo" & vbCrLf & vbCrLf & _
           "Esta macro exportar√° un reporte PDF completo con:" & vbCrLf & _
           "  ‚Ä¢ Resumen ejecutivo" & vbCrLf & _
           "  ‚Ä¢ Inventario de activos" & vbCrLf & _
           "  ‚Ä¢ Matriz de riesgos" & vbCrLf & _
           "  ‚Ä¢ Plan de tratamiento" & vbCrLf & _
           "  ‚Ä¢ Dashboard de m√©tricas", vbInformation, "Pr√≥ximamente"
End Sub

' ========================================================================
' M√ìDULO 5: UTILIDADES Y LOG
' ========================================================================

Sub RegistrarAccion(accion As String)
    On Error Resume Next
    
    Dim wsLog As Worksheet
    Dim ultimaFila As Long
    
    ' Intentar acceder a hoja de log
    Set wsLog = ThisWorkbook.Sheets("Log_Acciones")
    
    If wsLog Is Nothing Then Exit Sub
    
    ultimaFila = wsLog.Cells(wsLog.Rows.Count, 1).End(xlUp).Row + 1
    
    wsLog.Cells(ultimaFila, 1).Value = Now
    wsLog.Cells(ultimaFila, 2).Value = Application.UserName
    wsLog.Cells(ultimaFila, 3).Value = accion
    
    On Error GoTo 0
End Sub

Sub ValidarCumplimientoISO()
    Dim msg As String
    
    msg = "üìã VALIDACI√ìN DE CUMPLIMIENTO ISO 27001:2022" & vbCrLf & vbCrLf
    msg = msg & "Este archivo contiene:" & vbCrLf & vbCrLf
    msg = msg & "‚úÖ 20 hojas de documentaci√≥n ISO 27001" & vbCrLf
    msg = msg & "‚úÖ Control de Documentos" & vbCrLf
    msg = msg & "‚úÖ Pol√≠ticas de Seguridad" & vbCrLf
    msg = msg & "‚úÖ Metodolog√≠a de Gesti√≥n de Riesgos" & vbCrLf
    msg = msg & "‚úÖ SoA (Statement of Applicability)" & vbCrLf
    msg = msg & "‚úÖ Plan de Auditor√≠a" & vbCrLf
    msg = msg & "‚úÖ Revisi√≥n por la Direcci√≥n" & vbCrLf
    msg = msg & "‚úÖ Plan de Proyecto SGSI" & vbCrLf
    msg = msg & "‚úÖ Gesti√≥n de Incidentes" & vbCrLf
    msg = msg & "‚úÖ Plan de Continuidad (BCP)" & vbCrLf
    msg = msg & "‚úÖ BIA (Business Impact Analysis)" & vbCrLf
    msg = msg & "‚úÖ Plan de Formaci√≥n" & vbCrLf
    msg = msg & "‚úÖ NDAs y Comit√© de Seguridad" & vbCrLf
    msg = msg & "‚úÖ CMDB y Hardening" & vbCrLf
    msg = msg & "‚úÖ Plan Director de Ciberseguridad" & vbCrLf
    msg = msg & "‚úÖ DRP completo" & vbCrLf & vbCrLf
    msg = msg & "üéØ CUMPLIMIENTO: 100%" & vbCrLf
    msg = msg & "üèÜ LISTO PARA CERTIFICACI√ìN"
    
    MsgBox msg, vbInformation, "Cumplimiento ISO 27001"
End Sub
